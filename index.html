<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-Person Motion Tracker</title>
<link rel="stylesheet" href="remixicon.min.css">
<meta name="theme-color" content="#000000">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

<style>
:root {
  --primary: #146ec2;
  --accent: #146ec2;
  --danger: #ff4b2b;
  --success: #00e676;
  --bg: #0a0a0c;
  --card: #16171d;
  --border: rgba(255,255,255,0.1);
  --sheet-height: 40vh;
}

* { 
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: var(--bg);
  color: white;
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  overflow: hidden;
  height: 100vh;
  position: relative;
}

.video-container {
  position: fixed;
  inset: 0;
  background: #000;
}

canvas { 
  width: 100%; 
  height: 100%; 
  object-fit: contain;
}

video {
  display: none;
}

.top-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
  padding: 20px;
  z-index: 100;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.top-bar h1 {
  font-size: 1.2rem;
  font-weight: 800;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  display: flex;
  align-items: center;
  gap: 8px;
}

.upload-btn {
  background: var(--primary);
  color: #000;
  border: none;
  padding: 10px 20px;
  border-radius: 50px;
  font-weight: 700;
  cursor: pointer;
  display: flex;color:white;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  transition: 0.2s;
}

.upload-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 5px 20px rgba(0, 242, 255, 0.4);
}

.bottom-sheet {
  position: fixed;
  bottom: ;
  left: 0;
  right: 0;
  background: var(--card);
  border-radius: 24px 24px 0 0;
  transform: translateY(calc(100% - 80px));
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 200;
  box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.6);
  max-height: 85vh;
  display: flex;
  flex-direction: column;
}

.bottom-sheet.expanded {
  transform: translateY(0);
}

.sheet-handle {
  width: 40px;
  height: 4px;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 2px;
  margin: 12px auto;
  cursor: pointer;
}

.sheet-header {
  padding: 0 20px 15px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
}

.sheet-title {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 700;
  font-size: 1.1rem;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.85rem;
  color: #888;
  background: rgba(255, 255, 255, 0.05);
  padding: 6px 12px;
  border-radius: 20px;
  margin-top: 8px;
}

.sheet-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.controls {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
}

.control-btn {
  flex: 1;
  padding: 16px;
  border: none;
  border-radius: 16px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: 0.2s;
  font-size: 0.95rem;
}

.control-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.control-btn.primary {
  background: var(--success);
  color: #000;
}

.control-btn.danger {
  background: var(--danger);
  color: white;
}

.control-btn:hover:not(:disabled) {
  transform: scale(1.02);
}

.control-btn:active:not(:disabled) {
  transform: scale(0.98);
}

.timeline {
  background: rgba(255, 255, 255, 0.05);
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
}

.timeline input {
  width: 100%;
  height: 6px;
  -webkit-appearance: none;
  appearance: none;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
  outline: none;
  cursor: pointer;
}

.timeline input::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: var(--primary);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 242, 255, 0.5);
}

.timeline input::-moz-range-thumb {
  width: 16px;
  height: 16px;
  background: var(--primary);
  border-radius: 50%;
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 8px rgba(0, 242, 255, 0.5);
}

.time-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
  color: #666;
  margin-top: 8px;
  font-variant-numeric: tabular-nums;
}

.people-section {
  margin-top: 20px;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
  font-weight: 700;
  font-size: 1rem;
}

.person-card {
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 12px;
  transition: 0.2s;
}

.person-card:active {
  transform: scale(0.98);
}

.person-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.person-title {
  font-weight: 700;
  font-size: 1.05rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.person-stats {
  display: flex;
  gap: 15px;
  font-size: 0.85rem;
  color: #888;
  margin-bottom: 12px;
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.copy-btn {
  width: 100%;
  padding: 12px;
  background: var(--success);
  color: #000;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 0.95rem;
}

.copy-btn:active {
  transform: scale(0.98);
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 15px;
  opacity: 0.3;
}

.overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 15px;
  background: rgba(0,0,0,0.85);
  z-index: 50;
}

.spinner {
  border: 3px solid rgba(0,242,255,.1);
  border-top: 3px solid var(--primary);
  border-radius: 50%;
  width: 45px;
  height: 45px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.toast {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--success);
  color: #000;
  padding: 15px 25px;
  border-radius: 50px;
  font-weight: 700;
  box-shadow: 0 10px 30px rgba(0, 230, 118, 0.4);
  animation: slideDown 0.3s ease;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 10px;
}

@keyframes slideDown {
  from { transform: translate(-50%, -100px); opacity: 0; }
  to { transform: translate(-50%, 0); opacity: 1; }
}

input[type="file"] {
  display: none;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .top-bar h1 {
    font-size: 1rem;
  }
  
  .upload-btn {
    padding: 8px 16px;
    font-size: 0.85rem;
  }
  
  .controls {
    flex-direction: column;
  }
}

/* Scrollbar styling */
.sheet-content::-webkit-scrollbar {
  width: 8px;
}

.sheet-content::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

.sheet-content::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

.sheet-content::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}
</style>
</head>
<body>

<div class="video-container">
  <video id="video" playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="overlay" class="overlay">
    <div class="spinner"></div>
    <div style="letter-spacing:1px; font-weight:500">LOADING AI MODEL</div>
    <div style="font-size:0.75rem; color:#666">~13MB download</div>
  </div>
</div>

<div class="top-bar">
  <h1>
    <img src="logo.png" width="40">
  </h1>
  <button class="upload-btn" onclick="fileInput.click()">
    <i class="ri-upload-2-line"></i>
    Upload Video
  </button>
</div>

<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-handle" onclick="toggleSheet()"></div>
  
  <div class="sheet-header" onclick="toggleSheet()">
    <div class="sheet-title">
      <span>Controls</span>
      <i class="ri-arrow-up-s-line" id="sheetIcon"></i>
    </div>
    <div class="status-badge" id="statusBadge">
      <i class="ri-error-warning-line"></i>
      <span id="statusText">Upload video to begin</span>
    </div>
  </div>

  <div class="sheet-content">
    <div class="timeline">
      <input id="timeline" type="range" min="0" max="1000" value="0">
      <div class="time-labels">
        <span id="current">0:00</span>
        <span id="total">0:00</span>
      </div>
    </div>

    <div class="controls">
      <button class="control-btn primary" id="playBtn" disabled>
        <i class="ri-play-fill"></i>
        Start Detection
      </button>
      <button class="control-btn danger" id="stopBtn" style="display:none">
        <i class="ri-stop-fill"></i>
        Stop
      </button>
    </div>

    <div class="people-section" id="peopleSection" style="display:none">
      <div class="section-header">
        <span>
          <i class="ri-team-line"></i>
          <span id="peopleCount">0 People</span>
        </span>
        <span style="font-size:0.85rem; color:#666" id="processingStatus"></span>
      </div>
      <div id="peopleGrid"></div>
    </div>

    <div class="empty-state" id="emptyState">
      <i class="ri-movie-2-line"></i>
      <div style="font-size:0.95rem">Upload a video to detect people</div>
      <div style="font-size:0.85rem; margin-top:5px">Supports up to 6 people simultaneously</div>
    </div>
  </div>
</div>

<input id="fileInput" type="file" accept="video/*">



<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const playBtn = document.getElementById('playBtn');
const stopBtn = document.getElementById('stopBtn');
const statusText = document.getElementById('statusText');
const statusBadge = document.getElementById('statusBadge');
const overlay = document.getElementById('overlay');
const timeline = document.getElementById('timeline');
const currentLabel = document.getElementById('current');
const totalLabel = document.getElementById('total');
const fileInput = document.getElementById('fileInput');
const peopleSection = document.getElementById('peopleSection');
const peopleGrid = document.getElementById('peopleGrid');
const peopleCount = document.getElementById('peopleCount');
const processingStatus = document.getElementById('processingStatus');
const emptyState = document.getElementById('emptyState');
const bottomSheet = document.getElementById('bottomSheet');
const sheetIcon = document.getElementById('sheetIcon');

let detector = null;
let isProcessing = false;
let shouldStop = false;
let allPeopleData = {};
let nextPersonId = 1;
let sheetExpanded = false;

const colors = ['#00f2ff', '#ff4b2b', '#00e676', '#ffd700', '#ff00ff', '#ff6b35', '#00bfff', '#ff1493'];

// MoveNet Keypoint Mapping for Reference
// 0: nose, 1-2: eyes, 3-4: ears, 5-6: shoulders, 7-8: elbows, 9-10: wrists, 11-12: hips, 13-14: knees, 15-16: ankles

// Toggle bottom sheet
function toggleSheet() {
  sheetExpanded = !sheetExpanded;
  bottomSheet.classList.toggle('expanded', sheetExpanded);
  sheetIcon.className = sheetExpanded ? 'ri-arrow-down-s-line' : 'ri-arrow-up-s-line';
}

// Initialize detector
async function initDetector() {
  try {
    const model = poseDetection.SupportedModels.MoveNet;
    const detectorConfig = {
      modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING,
      enableTracking: true,
      trackerType: poseDetection.TrackerType.BoundingBox
    };
    
    detector = await poseDetection.createDetector(model, detectorConfig);
    
    overlay.style.display = 'none';
    updateStatus('Upload video to begin', 'ri-checkbox-circle-line');
  } catch (err) {
    overlay.innerHTML = '<div style="color:var(--danger)"><i class="ri-error-warning-line"></i> Failed to load AI model</div>';
  }
}

function updateStatus(text, icon = 'ri-information-line') {
  statusText.textContent = text;
  const iconEl = statusBadge.querySelector('i');
  iconEl.className = icon;
}

// Real-time detection
async function startRealTimeDetection() {
  if (!detector || isProcessing) return;
  
  isProcessing = true;
  shouldStop = false;
  allPeopleData = {};
  nextPersonId = 1;
  
  playBtn.style.display = 'none';
  stopBtn.style.display = 'flex';
  peopleSection.style.display = 'none';
  emptyState.style.display = 'none';
  
  video.currentTime = 0;
  video.play();
  
  updateStatus('Detecting people...', 'ri-radar-line');
  detectLoop();
}

async function detectLoop() {
  if (video.paused || video.ended || shouldStop) {
    video.pause();
    isProcessing = false;
    playBtn.style.display = 'flex';
    stopBtn.style.display = 'none';
    
    if (shouldStop) {
      updateStatus('Processing stopped', 'ri-stop-circle-line');
    } else {
      updateStatus(`Complete! ${Object.keys(allPeopleData).length} people found`, 'ri-checkbox-circle-line');
    }
    
    if (Object.keys(allPeopleData).length > 0) {
      showPeopleList();
    } else {
      emptyState.style.display = 'block';
    }
    return;
  }
  
  try {
    const poses = await detector.estimatePoses(video, {
      maxPoses: 6,
      flipHorizontal: false
    });
    
    trackAndStorePoses(poses, video.currentTime);
    drawResults(poses);
    
    const progress = Math.floor((video.currentTime / video.duration) * 100);
    processingStatus.textContent = `${progress}%`;
    updateStatus(`Detecting: ${Object.keys(allPeopleData).length} people`, 'ri-radar-line');
    
    timeline.value = (video.currentTime / video.duration) * 1000;
    currentLabel.textContent = formatTime(video.currentTime);
    
  } catch (err) {
    console.error('Detection error:', err);
  }
  
  requestAnimationFrame(detectLoop);
}

function analyzeBodyDetails(keypoints) {
  const parts = [];
  const minScore = 0.35;

  // Head (Nose is index 0)
  if (keypoints[0].score > minScore) parts.push("Head");
  
  // Hands (Wrists are 9 and 10)
  if (keypoints[9].score > minScore || keypoints[10].score > minScore) parts.push("Hands");
  
  // Bottom Area (Ankles are 15 and 16)
  if (keypoints[15].score > minScore || keypoints[16].score > minScore) parts.push("Feet/Ankles");

  return parts.length > 0 ? parts.join(" + ") : "Torso only";
}

function trackAndStorePoses(poses, time) {
  poses.forEach(pose => {
    if (pose.keypoints.length === 0) return;
    
    const validPoints = pose.keypoints.filter(kp => kp.score > 0.3);
    if (validPoints.length < 5) return;
    
    const centerX = validPoints.reduce((sum, kp) => sum + kp.x, 0) / validPoints.length;
    const centerY = validPoints.reduce((sum, kp) => sum + kp.y, 0) / validPoints.length;
    
    let matchedId = null;
    let minDist = Infinity;
    
    Object.entries(allPeopleData).forEach(([id, person]) => {
      if (person.frames.length === 0) return;
      const lastFrame = person.frames[person.frames.length - 1];
      const timeDiff = time - parseFloat(lastFrame.time);
      if (timeDiff > 0.5) return;
      
      const dist = Math.sqrt((centerX - lastFrame.centerX) ** 2 + (centerY - lastFrame.centerY) ** 2);
      if (dist < 80 && dist < minDist) {
        minDist = dist;
        matchedId = id;
      }
    });

    const bodyStatus = analyzeBodyDetails(pose.keypoints);
    
    const frameEntry = {
      time: time.toFixed(3),
      keypoints: pose.keypoints,
      centerX,
      centerY,
      activeParts: bodyStatus
    };
    
    if (matchedId) {
      allPeopleData[matchedId].frames.push(frameEntry);
    } else {
      const newId = nextPersonId++;
      allPeopleData[newId] = {
        id: newId,
        color: colors[(newId - 1) % colors.length],
        frames: [frameEntry]
      };
    }
  });
}

function drawResults(poses) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.globalAlpha = 0.4;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  ctx.globalAlpha = 1.0;
  
  poses.forEach(pose => {
    drawPerson(pose, '#00f2ff');
  });
}

function drawPerson(pose, color) {
  const keypoints = pose.keypoints;
  const minConfidence = 0.3;
  
  const connections = [
    [0, 1], [0, 2], [1, 3], [2, 4],
    [5, 6], [5, 7], [7, 9], [6, 8], [8, 10],
    [5, 11], [6, 12], [11, 12],
    [11, 13], [13, 15], [12, 14], [14, 16]
  ];
  
  ctx.strokeStyle = color;
  ctx.lineWidth = 3;
  
  // Draw Skeleton
  connections.forEach(([i, j]) => {
    const kp1 = keypoints[i];
    const kp2 = keypoints[j];
    if (kp1.score > minConfidence && kp2.score > minConfidence) {
      ctx.beginPath();
      ctx.moveTo(kp1.x, kp1.y);
      ctx.lineTo(kp2.x, kp2.y);
      ctx.stroke();
    }
  });
  
  // Draw Keypoints with special highlighting for Hands and Feet
  keypoints.forEach((kp, index) => {
    if (kp.score > minConfidence) {
      ctx.beginPath();
      
      // Special Colors for specific detection
      if (index === 0) ctx.fillStyle = "#ff00ff"; // Head (Nose)
      else if (index === 9 || index === 10) ctx.fillStyle = "#ffff00"; // Hands
      else if (index === 15 || index === 16) ctx.fillStyle = "#00ff00"; // Feet/Ankles
      else ctx.fillStyle = color;

      ctx.arc(kp.x, kp.y, index === 9 || index === 15 ? 7 : 4, 0, Math.PI * 2);
      ctx.fill();
    }
  });
}

function showPeopleList() {
  peopleSection.style.display = 'block';
  emptyState.style.display = 'none';
  peopleGrid.innerHTML = '';
  
  const sortedPeople = Object.values(allPeopleData).sort((a, b) => b.frames.length - a.frames.length);
  peopleCount.textContent = `${sortedPeople.length} Detected`;
  
  sortedPeople.forEach(person => {
    const lastFrame = person.frames[person.frames.length - 1];
    const card = document.createElement('div');
    card.className = 'person-card';
    card.style.borderLeft = `5px solid ${person.color}`;
    
    card.innerHTML = `
      <div class="person-header">
        <div class="person-title" style="color: ${person.color}">
          <i class="ri-focus-3-line"></i> Person ${person.id}
        </div>
      </div>
      <div class="person-stats">
        <div class="stat-item"><i class="ri-user-smile-line"></i> ${lastFrame.activeParts}</div>
        <div class="stat-item"><i class="ri-history-line"></i> ${person.frames.length} frames</div>
      </div>
      <button class="copy-btn" onclick="copyPersonJSON(${person.id})">
        Copy Full Motion Data
      </button>
    `;
    peopleGrid.appendChild(card);
  });
  
  if (!sheetExpanded) toggleSheet();
}

window.copyPersonJSON = function(personId) {
  const person = allPeopleData[personId];
  if (!person) return;
  
  const formattedData = {
    person_id: personId,
    total_frames: person.frames.length,
    data: person.frames.map(frame => ({
      time: frame.time,
      active_parts: frame.activeParts,
      keypoints: frame.keypoints.map(kp => ({
        part: kp.name,
        x: Math.round(kp.x),
        y: Math.round(kp.y),
        score: kp.score.toFixed(2)
      }))
    }))
  };
  
  navigator.clipboard.writeText(JSON.stringify(formattedData, null, 2)).then(() => {
    showToast(`JSON for Person ${personId} copied!`);
  });
};

function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerHTML = `<i class="ri-checkbox-circle-fill"></i> ${message}`;
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2000);
}

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

fileInput.onchange = e => {
  const f = e.target.files[0];
  if (!f) return;
  video.src = URL.createObjectURL(f);
  video.onloadedmetadata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    totalLabel.textContent = formatTime(video.duration);
    playBtn.disabled = false;
    updateStatus('Ready', 'ri-checkbox-circle-line');
  };
};

playBtn.onclick = () => startRealTimeDetection();
stopBtn.onclick = () => { shouldStop = true; };
initDetector();
</script>

</body>
</html>